general:
  artifacts:
    - "build"

machine:
  node:
    version: 8.2.1
  timezone:
    Australia/Sydney
  environment:
    PATH: "${PATH}:${HOME}/${CIRCLE_PROJECT_REPONAME}/node_modules/.bin"

dependencies:
  pre:
    - curl -v -L -o cf-cli_amd64.deb 'https://cli.run.pivotal.io/stable?release=debian64&source=github'
    - sudo dpkg -i cf-cli_amd64.deb
    - cf install-plugin https://github.com/govau/autopilot/releases/download/0.0.5-venapp/autopilot-linux -f
    - cf -v
  override:
    - find . -name "node_modules" -exec rm -rf '{}' + # removing all node_modules/ folder cause circle canâ€™t be trusted with it.
    - npm install
    - npm run build

test:
  override:
    - eslint .
    - npm test

deployment:
  development:
    branch: master
    commands:
      - cf login -a https://api.system.y.cld.gov.au -o dta -s marketplace -u $CF_USER_STAGING -p $CF_PASSWORD_STAGING
      - cf zero-downtime-push dm-dev-frontend -f manifest.yml --show-app-log
  production:
    tag: /[0-9]+(\.[0-9]+)*/
    commands:
      - cf login -a https://api.system.b.cld.gov.au -o dta -s marketplace -u $CF_USER_PROD -p $CF_PASSWORD_PROD
      - cf zero-downtime-push dm-frontend -f manifest-prod.yml --show-app-log
      - ./scripts/ci-notify.sh
